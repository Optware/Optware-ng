From 3311842e8c66bf2621a4959bc6307e8ecf08c0bf Mon Sep 17 00:00:00 2001
From: Volker Lendecke <vl@samba.org>
Date: Fri, 10 Feb 2012 08:10:39 +0100
Subject: [PATCH] v3-3: AndX offsets are increasing strictly monotonically
Ulmer: Adjusted so that patch applies against 3.2.15 with samba-3.3.12-CVE-2010-2063.patch applied
--- a/source/smbd/process.c	2012-04-27 23:16:14.841615451 +0200
+++ b/source/smbd/process.c	2012-04-27 23:19:35.592469469 +0200
@@ -1652,7 +1652,7 @@
 	int size = smb_len(req->inbuf)+4;
 
 	int smb_com1, smb_com2 = CVAL(inbuf,smb_vwv0);
-	unsigned smb_off2 = SVAL(inbuf,smb_vwv1);
+	static unsigned smb_off2;
 	char *inbuf2;
 	int outsize2;
 	int new_size;
@@ -1677,7 +1677,15 @@
 		/* this is the first part of the chain */
 		orig_inbuf = inbuf;
 		orig_size = size;
+		smb_off2 = 0;
 	}
+	
+	if (SVAL(inbuf,smb_vwv1) <= smb_off2) {
+		DEBUG(1, ("AndX offset not increasing\n"));
+		SCVAL(outbuf, smb_vwv0, 0xFF);
+		return;
+	}
+	smb_off2 = SVAL(inbuf, smb_vwv1);
 
 	/* Validate smb_off2 */
 	if ((smb_off2 < smb_wct - 4) || orig_size < (smb_off2 + 4 - smb_wct)) {
